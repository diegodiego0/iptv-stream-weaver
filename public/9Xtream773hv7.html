<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>9XTREAM - Premium Streaming</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://vjs.zencdn.net">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg-primary: #0a0a0f;
  --bg-secondary: #12121a;
  --bg-card: #1a1a25;
  --bg-hover: #252535;
  --bg-glass: rgba(26, 26, 37, 0.85);
  --accent: #00d4ff;
  --accent-secondary: #7c3aed;
  --accent-glow: rgba(0, 212, 255, 0.25);
  --accent-glow-strong: rgba(0, 212, 255, 0.5);
  --text-primary: #ffffff;
  --text-secondary: #a0a0b0;
  --text-muted: #606070;
  --danger: #ff4757;
  --success: #10b981;
  --warning: #f59e0b;
  --gradient-accent: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
  --gradient-accent-hover: linear-gradient(135deg, #00b8e6 0%, #6d28d9 100%);
  --gradient-bg: linear-gradient(180deg, #0a0a0f 0%, #12121a 100%);
  --gradient-card: linear-gradient(145deg, rgba(26, 26, 37, 0.9) 0%, rgba(18, 18, 26, 0.95) 100%);
  --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.4);
  --shadow-glow: 0 0 30px var(--accent-glow);
  --shadow-glow-strong: 0 0 50px var(--accent-glow-strong);
  --shadow-elevated: 0 20px 60px rgba(0, 0, 0, 0.5);
  --radius: 16px;
  --radius-sm: 10px;
  --radius-lg: 24px;
  --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background: var(--gradient-bg);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent) 0%, var(--accent-secondary) 100%); border-radius: 4px; }
::selection { background: var(--accent); color: var(--bg-primary); }

/* LOGIN */
#loginScreen {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: radial-gradient(ellipse at top, #1a1a2e 0%, #0a0a0f 50%, #050508 100%);
  position: relative; overflow: hidden;
}
#loginScreen::before {
  content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: radial-gradient(circle at 30% 20%, rgba(0, 212, 255, 0.08) 0%, transparent 40%),
              radial-gradient(circle at 70% 80%, rgba(124, 58, 237, 0.08) 0%, transparent 40%);
  animation: floatBg 20s ease-in-out infinite;
}
@keyframes floatBg { 0%, 100% { transform: translate(0, 0); } 33% { transform: translate(2%, 2%); } 66% { transform: translate(-1%, 1%); } }

.login-container {
  background: var(--gradient-card); backdrop-filter: blur(20px); border-radius: var(--radius-lg);
  padding: 3rem; width: 100%; max-width: 440px;
  box-shadow: var(--shadow-elevated), 0 0 80px rgba(0, 212, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.08); position: relative; z-index: 1;
  animation: fadeInUp 0.6s ease-out;
}
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

.login-header { text-align: center; margin-bottom: 2.5rem; }
.login-header .logo { font-size: 4rem; margin-bottom: 1rem; display: block; filter: drop-shadow(0 0 20px var(--accent-glow)); animation: pulse-glow 3s ease-in-out infinite; }
@keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 20px var(--accent-glow)); } 50% { filter: drop-shadow(0 0 35px var(--accent-glow-strong)); } }
.login-header h1 { font-size: 2rem; font-weight: 800; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.login-header p { color: var(--text-muted); font-size: 0.95rem; margin-top: 0.5rem; }

.form-floating { margin-bottom: 1.25rem; }
.form-floating .form-control { background: rgba(18, 18, 26, 0.8); border: 2px solid rgba(255, 255, 255, 0.08); color: var(--text-primary); border-radius: var(--radius); height: 60px; padding: 1rem; font-size: 1rem; transition: var(--transition-smooth); }
.form-floating .form-control:focus { background: rgba(18, 18, 26, 0.95); border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); color: var(--text-primary); }
.form-floating .form-control::placeholder { color: transparent; }
.form-floating label { color: var(--text-muted); padding: 1rem; }

.btn-login { width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 700; background: var(--gradient-accent); border: none; border-radius: var(--radius); color: white; cursor: pointer; transition: var(--transition-bounce); margin-top: 0.75rem; position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 1px; }
.btn-login::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: 0.5s; }
.btn-login:hover::before { left: 100%; }
.btn-login:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-glow-strong); }
.btn-login:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

/* APP LAYOUT */
#app { display: none; min-height: 100vh; padding-bottom: 80px; }

.app-header { background: var(--bg-glass); backdrop-filter: blur(20px); padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.06); position: sticky; top: 0; z-index: 100; transition: var(--transition-smooth); }
.app-header.scrolled { background: rgba(10, 10, 15, 0.98); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); }
.app-logo { display: flex; align-items: center; gap: 0.75rem; font-weight: 800; font-size: 1.5rem; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; white-space: nowrap; }
.app-logo .logo-icon { font-size: 1.75rem; filter: drop-shadow(0 0 10px var(--accent-glow)); }

.search-box { flex: 1; max-width: 500px; position: relative; }
.search-box input { width: 100%; padding: 0.875rem 1.25rem 0.875rem 3rem; background: rgba(26, 26, 37, 0.8); border: 2px solid rgba(255, 255, 255, 0.08); border-radius: 50px; color: var(--text-primary); font-size: 0.95rem; transition: var(--transition-smooth); }
.search-box input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); }
.search-box input::placeholder { color: var(--text-muted); }
.search-box i { position: absolute; left: 1.25rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
.search-box:focus-within i { color: var(--accent); }

.header-actions { display: flex; align-items: center; gap: 0.5rem; }
.btn-icon { width: 44px; height: 44px; border-radius: 50%; background: rgba(26, 26, 37, 0.8); border: 2px solid rgba(255, 255, 255, 0.08); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition-bounce); font-size: 1.1rem; }
.btn-icon:hover { background: var(--gradient-accent); color: white; border-color: transparent; transform: scale(1.1); box-shadow: var(--shadow-glow); }

.cache-indicator { display: flex; align-items: center; gap: 0.5rem; padding: 0.375rem 1rem; background: rgba(26, 26, 37, 0.8); border-radius: 50px; font-size: 0.75rem; color: var(--text-muted); border: 1px solid rgba(255, 255, 255, 0.06); }
.cache-indicator.active { color: var(--success); border-color: rgba(16, 185, 129, 0.3); }
.cache-indicator .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
.cache-indicator.active .dot { background: var(--success); box-shadow: 0 0 10px var(--success); animation: pulse 2s infinite; }

/* BOTTOM NAV */
.nav-tabs-bottom { background: var(--bg-glass); backdrop-filter: blur(20px); padding: 0.75rem 1rem; display: flex; justify-content: space-around; gap: 0.5rem; border-top: 1px solid rgba(255, 255, 255, 0.06); position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3); }
.nav-tab { display: flex; flex-direction: column; align-items: center; gap: 0.375rem; padding: 0.625rem 1.25rem; background: transparent; border: none; border-radius: var(--radius); color: var(--text-muted); font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: var(--transition-bounce); white-space: nowrap; position: relative; }
.nav-tab::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 0; height: 3px; background: var(--gradient-accent); border-radius: 0 0 3px 3px; transition: var(--transition-smooth); }
.nav-tab:hover { color: var(--text-primary); background: rgba(255, 255, 255, 0.05); }
.nav-tab.active { color: var(--accent); }
.nav-tab.active::before { width: 60%; }
.nav-tab.active i { filter: drop-shadow(0 0 8px var(--accent-glow)); }
.nav-tab i { font-size: 1.5rem; }

/* MAIN CONTENT */
.main-content { display: grid; grid-template-columns: 280px 1fr; min-height: calc(100vh - 150px); }
.sidebar-categories { background: var(--bg-secondary); border-right: 1px solid rgba(255, 255, 255, 0.05); overflow-y: auto; max-height: calc(100vh - 150px); position: sticky; top: 76px; }
.sidebar-header { padding: 1.25rem 1rem; font-weight: 700; color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); display: flex; justify-content: space-between; align-items: center; background: rgba(0, 0, 0, 0.2); }
.cache-badge { font-size: 0.6rem; padding: 0.2rem 0.6rem; background: var(--gradient-accent); color: white; border-radius: 50px; font-weight: 700; }
.category-list { padding: 0.5rem; }
.category-item { display: flex; align-items: center; justify-content: space-between; padding: 0.875rem 1rem; border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; transition: var(--transition-smooth); font-size: 0.9rem; font-weight: 500; margin-bottom: 0.25rem; }
.category-item:hover { background: var(--bg-hover); color: var(--text-primary); transform: translateX(4px); }
.category-item.active { background: var(--gradient-accent); color: white; box-shadow: var(--shadow-glow); }

.content-area { padding: 1.5rem; overflow-y: auto; }
.content-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
.content-title { font-size: 1.5rem; font-weight: 700; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.content-count { color: var(--text-muted); font-size: 0.9rem; }

/* PLAYER */
.player-section { background: linear-gradient(145deg, rgba(18, 18, 26, 0.95) 0%, rgba(10, 10, 15, 0.98) 100%); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 1.5rem; box-shadow: var(--shadow-elevated); border: 1px solid rgba(255, 255, 255, 0.05); position: relative; }
.player-section.sticky-player { position: fixed; top: 76px; right: 1rem; width: 360px; z-index: 90; border-radius: var(--radius); box-shadow: var(--shadow-elevated), var(--shadow-glow); }
.player-section.sticky-player .player-info { padding: 0.5rem 0.75rem; }
.player-section.sticky-player .player-episodes-section { display: none !important; }
.sticky-player-close { position: absolute; top: 0.5rem; right: 0.5rem; width: 28px; height: 28px; background: rgba(0,0,0,0.7); border: none; border-radius: 50%; color: white; font-size: 0.8rem; cursor: pointer; z-index: 10; display: none; align-items: center; justify-content: center; }
.sticky-player .sticky-player-close { display: flex; }
.sticky-player-close:hover { background: var(--danger); }

.video-js { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
.player-info { padding: 1rem 1.5rem; background: var(--bg-card); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
.now-playing { display: flex; align-items: center; gap: 1rem; }
.now-playing-dot { width: 10px; height: 10px; background: var(--danger); border-radius: 50%; animation: pulse 2s infinite; box-shadow: 0 0 10px var(--danger); }
@keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(0.9); } }
.now-playing-text { font-weight: 600; font-size: 1rem; }
.stream-info { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--text-muted); }

/* EPISODES */
.player-episodes-section { background: var(--bg-card); border-radius: 0 0 var(--radius-lg) var(--radius-lg); padding: 1.25rem 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.05); display: none; }
.player-episodes-section.show { display: block; animation: slideDown 0.3s ease-out; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.episodes-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
.episodes-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
.episodes-title i { color: var(--accent); }
.seasons-tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.season-tab { padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.05); border: 2px solid transparent; border-radius: 50px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: var(--transition-smooth); }
.season-tab:hover { background: rgba(255, 255, 255, 0.1); color: var(--text-primary); }
.season-tab.active { background: var(--gradient-accent); color: white; box-shadow: var(--shadow-glow); }
.episodes-scroll { display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 0.75rem; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
.episodes-scroll::-webkit-scrollbar { height: 6px; }
.episodes-scroll::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }

.episode-card-horizontal { flex: 0 0 auto; width: 200px; background: var(--bg-secondary); border-radius: var(--radius-sm); padding: 1rem; cursor: pointer; transition: var(--transition-bounce); border: 2px solid transparent; position: relative; overflow: hidden; }
.episode-card-horizontal::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--gradient-accent); opacity: 0; transition: var(--transition-smooth); }
.episode-card-horizontal:hover { background: var(--bg-hover); border-color: var(--accent); transform: translateY(-4px); box-shadow: var(--shadow-glow); }
.episode-card-horizontal:hover::before { opacity: 1; }
.episode-card-horizontal.playing { background: rgba(0, 212, 255, 0.1); border-color: var(--accent); }
.episode-card-horizontal.playing::before { opacity: 1; }
.episode-number-badge { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: var(--gradient-accent); border-radius: var(--radius-sm); font-weight: 700; font-size: 0.9rem; margin-bottom: 0.75rem; color: white; }
.episode-card-horizontal .ep-title { font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 0.25rem; }
.episode-card-horizontal .ep-duration { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.25rem; }

/* GRID */
.items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1.25rem; }

.item-card { background: var(--gradient-card); border-radius: var(--radius); overflow: hidden; cursor: pointer; transition: var(--transition-bounce); border: 2px solid rgba(255, 255, 255, 0.05); position: relative; }
.item-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--shadow-elevated), var(--shadow-glow); border-color: var(--accent); }
.item-poster { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: var(--bg-secondary); transition: var(--transition-smooth); }
.item-card:hover .item-poster { transform: scale(1.05); }
.item-poster-live { aspect-ratio: 16/9; }
.item-info { padding: 0.875rem; background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 100%); position: absolute; bottom: 0; left: 0; right: 0; }
.item-title { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.item-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; display: flex; align-items: center; gap: 0.5rem; }

.stream-type-badge { position: absolute; bottom: 60px; left: 0.5rem; display: flex; gap: 0.25rem; flex-wrap: wrap; }
.stream-badge { font-size: 0.55rem; font-weight: 700; padding: 0.2rem 0.5rem; border-radius: 4px; text-transform: uppercase; }
.stream-badge.hls { background: var(--accent); color: white; }
.stream-badge.ts { background: #9b59b6; color: white; }
.stream-badge.mp4 { background: var(--success); color: white; }
.stream-badge.hd { background: #f1c40f; color: #000; }
.stream-badge.fhd { background: #e67e22; color: white; }
.stream-badge.uhd { background: #e74c3c; color: white; }
.stream-badge.h264 { background: #3498db; color: white; }
.stream-badge.h265 { background: #8e44ad; color: white; }

.item-badge { position: absolute; top: 0.75rem; right: 0.75rem; background: var(--gradient-accent); color: white; font-size: 0.7rem; font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 50px; }
.item-favorite { position: absolute; top: 0.75rem; left: 0.75rem; width: 36px; height: 36px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: var(--transition-bounce); border: none; cursor: pointer; z-index: 10; }
.item-favorite:hover { background: var(--danger); color: white; transform: scale(1.15); }
.item-favorite.active { background: var(--danger); color: white; }

.item-play-overlay { position: absolute; inset: 0; background: linear-gradient(180deg, transparent 40%, rgba(0,0,0,0.8) 100%); display: flex; align-items: center; justify-content: center; opacity: 0; transition: var(--transition-smooth); }
.item-card:hover .item-play-overlay { opacity: 1; }
.play-btn { width: 60px; height: 60px; background: var(--gradient-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; box-shadow: var(--shadow-glow-strong); transition: var(--transition-bounce); }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; backdrop-filter: blur(20px); }
.modal-overlay.show { display: flex; animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal-content { background: var(--gradient-card); border-radius: var(--radius-lg); width: 100%; max-width: 950px; max-height: 92vh; overflow-y: auto; box-shadow: var(--shadow-elevated); border: 1px solid rgba(255, 255, 255, 0.1); animation: slideUp 0.4s ease-out; }
@keyframes slideUp { from { opacity: 0; transform: translateY(40px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

.modal-header { position: relative; padding: 0; }
.modal-backdrop-img { width: 100%; height: 350px; object-fit: cover; }
.modal-backdrop-gradient { position: absolute; inset: 0; background: linear-gradient(to top, var(--bg-card) 0%, transparent 60%); }
.modal-close { position: absolute; top: 1rem; right: 1rem; width: 44px; height: 44px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-bounce); z-index: 10; font-size: 1.2rem; }
.modal-close:hover { background: var(--danger); transform: rotate(90deg) scale(1.1); }
.modal-body { padding: 2rem; margin-top: -100px; position: relative; }
.modal-poster-container { display: flex; gap: 2rem; }
.modal-poster { width: 200px; height: 300px; object-fit: cover; border-radius: var(--radius); box-shadow: var(--shadow-elevated); flex-shrink: 0; border: 3px solid rgba(255, 255, 255, 0.1); }
.modal-details { flex: 1; }
.modal-title { font-size: 2rem; font-weight: 800; margin-bottom: 0.75rem; line-height: 1.2; }
.modal-meta { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem; }
.modal-meta span { display: flex; align-items: center; gap: 0.35rem; }
.modal-rating { color: var(--warning) !important; font-weight: 600; }
.modal-genres { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.25rem; }
.genre-tag { background: rgba(255, 255, 255, 0.08); padding: 0.375rem 0.875rem; border-radius: 50px; font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; border: 1px solid rgba(255, 255, 255, 0.05); }
.modal-description { color: var(--text-secondary); line-height: 1.7; margin-bottom: 1.5rem; font-size: 0.95rem; }
.modal-cast { margin-bottom: 1.5rem; }
.modal-cast-title { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
.modal-cast-list { color: var(--text-secondary); font-size: 0.9rem; }
.modal-actions { display: flex; gap: 1rem; flex-wrap: wrap; }
.btn-play { display: flex; align-items: center; gap: 0.5rem; padding: 1rem 2rem; background: var(--gradient-accent); border: none; border-radius: var(--radius); color: white; font-size: 1rem; font-weight: 700; cursor: pointer; transition: var(--transition-bounce); text-transform: uppercase; }
.btn-play:hover { transform: scale(1.05); box-shadow: var(--shadow-glow-strong); }
.btn-secondary { display: flex; align-items: center; gap: 0.5rem; padding: 1rem 1.5rem; background: rgba(255, 255, 255, 0.08); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius); color: var(--text-primary); font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition-smooth); }
.btn-secondary:hover { background: rgba(255, 255, 255, 0.12); border-color: var(--accent); }

.seasons-section { margin-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.08); padding-top: 1.5rem; }
.seasons-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
.seasons-header h3 { font-size: 1.1rem; font-weight: 700; }
.season-select { background: var(--bg-secondary); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius-sm); padding: 0.625rem 1rem; color: var(--text-primary); font-size: 0.9rem; cursor: pointer; }
.season-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
.episodes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; max-height: 400px; overflow-y: auto; }
.episode-card { display: flex; gap: 1rem; background: var(--bg-secondary); border-radius: var(--radius-sm); padding: 1rem; cursor: pointer; transition: var(--transition-smooth); border: 2px solid transparent; }
.episode-card:hover { background: var(--bg-hover); border-color: var(--accent); transform: translateX(4px); }
.episode-number { width: 44px; height: 44px; background: var(--gradient-accent); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; flex-shrink: 0; }
.episode-info { flex: 1; min-width: 0; }
.episode-title { font-size: 0.95rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.episode-duration { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; display: flex; align-items: center; gap: 0.25rem; }

.account-info { padding: 0.5rem 0; }
.account-row { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
.account-row:last-child { border-bottom: none; }
.account-label { color: var(--text-muted); font-size: 0.9rem; }
.account-value { font-weight: 600; font-size: 0.95rem; }
.status-active { color: var(--success); }
.status-expired { color: var(--danger); }

/* LOADING */
.loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5rem; color: var(--text-muted); }
.loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1.5rem; }
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state { text-align: center; padding: 5rem 2rem; color: var(--text-muted); }
.empty-state i { font-size: 5rem; margin-bottom: 1.5rem; opacity: 0.3; }
.empty-state h3 { font-size: 1.5rem; color: var(--text-secondary); margin-bottom: 0.75rem; font-weight: 600; }

.toast-container { position: fixed; bottom: 100px; right: 1.5rem; z-index: 1100; }
.toast { background: var(--bg-card); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--radius); padding: 1rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; box-shadow: var(--shadow-elevated); animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); margin-top: 0.75rem; backdrop-filter: blur(10px); }
.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--danger); }
.toast.info { border-left: 4px solid var(--accent); }
@keyframes slideInRight { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* SKELETON */
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
.skeleton-card { flex: 0 0 auto; width: 160px; border-radius: var(--radius); overflow: hidden; background: var(--bg-card); }
.skeleton-card .skel-img { width: 100%; aspect-ratio: 2/3; background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-hover) 50%, var(--bg-secondary) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
.skeleton-card.live .skel-img { aspect-ratio: 16/9; }
.skeleton-card .skel-text { padding: 0.625rem; }
.skeleton-card .skel-line { height: 12px; background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-hover) 50%, var(--bg-secondary) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; width: 70%; }

.item-skeleton { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; }
.item-skeleton .skeleton-poster { width: 100%; aspect-ratio: 2/3; background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-hover) 50%, var(--bg-secondary) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
.item-skeleton .skeleton-info { padding: 0.875rem; }
.item-skeleton .skeleton-title { height: 16px; background: var(--bg-secondary); border-radius: 4px; width: 75%; }

/* HOMEPAGE */
#homeSection { display: block; }
.home-banner { position: relative; width: 100%; height: 55vh; min-height: 320px; max-height: 550px; overflow: hidden; margin-bottom: 1.5rem; }
.banner-slide { position: absolute; inset: 0; opacity: 0; transition: opacity 0.8s ease-in-out; }
.banner-slide.active { opacity: 1; }
.banner-slide img { width: 100%; height: 100%; object-fit: cover; }
.banner-gradient { position: absolute; inset: 0; background: linear-gradient(to top, var(--bg-primary) 0%, rgba(10,10,15,0.6) 40%, transparent 70%), linear-gradient(to right, rgba(10,10,15,0.8) 0%, transparent 50%); }
.banner-info { position: absolute; bottom: 2.5rem; left: 2rem; right: 2rem; z-index: 5; }
.banner-info h2 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; text-shadow: 0 2px 20px rgba(0,0,0,0.5); line-height: 1.15; }
.banner-info .banner-meta { display: flex; gap: 1rem; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem; flex-wrap: wrap; }
.banner-info .banner-desc { color: var(--text-secondary); font-size: 0.9rem; max-width: 500px; line-height: 1.6; margin-bottom: 1.25rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.banner-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
.banner-dots { position: absolute; bottom: 1rem; right: 2rem; display: flex; gap: 0.5rem; z-index: 5; }
.banner-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.3); cursor: pointer; transition: var(--transition-smooth); border: none; }
.banner-dot.active { background: var(--accent); box-shadow: 0 0 10px var(--accent-glow); width: 28px; border-radius: 5px; }

.home-row { margin-bottom: 2rem; padding: 0 1.5rem; }
.home-row-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
.home-row-title { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
.home-row-title i { color: var(--accent); }
.btn-ver-mais { background: transparent; border: 2px solid rgba(255,255,255,0.15); color: var(--accent); font-size: 0.8rem; font-weight: 600; padding: 0.4rem 1rem; border-radius: 50px; cursor: pointer; transition: var(--transition-smooth); }
.btn-ver-mais:hover { background: var(--accent); color: white; border-color: var(--accent); }
.home-row-scroll { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 0.75rem; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
.home-row-scroll::-webkit-scrollbar { height: 6px; }
.home-row-scroll::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }

.home-card { flex: 0 0 auto; width: 160px; background: var(--gradient-card); border-radius: var(--radius); overflow: hidden; cursor: pointer; transition: var(--transition-bounce); border: 2px solid rgba(255,255,255,0.05); position: relative; }
.home-card:hover { transform: translateY(-6px) scale(1.03); box-shadow: var(--shadow-elevated), var(--shadow-glow); border-color: var(--accent); }
.home-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: var(--bg-secondary); }
.home-card.live-card img { aspect-ratio: 16/9; }
.home-card .home-card-info { padding: 0.625rem; background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.85) 100%); position: absolute; bottom: 0; left: 0; right: 0; }
.home-card .home-card-title { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.home-card .home-card-meta { font-size: 0.65rem; color: var(--text-muted); margin-top: 0.15rem; }
.home-card .home-card-play { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); opacity: 0; transition: var(--transition-smooth); }
.home-card:hover .home-card-play { opacity: 1; }
.home-card .home-card-play i { font-size: 2rem; color: white; filter: drop-shadow(0 0 10px rgba(0,212,255,0.5)); }

/* VER MAIS */
.ver-mais-overlay { position: fixed; inset: 0; background: var(--bg-primary); z-index: 200; display: none; flex-direction: column; }
.ver-mais-overlay.show { display: flex; animation: fadeIn 0.3s ease-out; }
.ver-mais-header { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; background: var(--bg-glass); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.06); }
.ver-mais-header h2 { flex: 1; font-size: 1.25rem; font-weight: 700; }
.ver-mais-back { width: 40px; height: 40px; background: rgba(255,255,255,0.08); border: none; border-radius: 50%; color: white; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.ver-mais-back:hover { background: var(--accent); }
.ver-mais-categories { display: flex; gap: 0.5rem; padding: 1rem 1.5rem; overflow-x: auto; flex-shrink: 0; }
.ver-mais-cat-btn { padding: 0.5rem 1.25rem; background: rgba(255,255,255,0.06); border: 2px solid transparent; border-radius: 50px; color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: var(--transition-smooth); }
.ver-mais-cat-btn:hover { background: rgba(255,255,255,0.1); }
.ver-mais-cat-btn.active { background: var(--gradient-accent); color: white; box-shadow: var(--shadow-glow); }
.ver-mais-content { flex: 1; overflow-y: auto; padding: 1rem 1.5rem; }
.ver-mais-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }

/* LANDSCAPE PLAYER */
@media (orientation: landscape) and (max-height: 500px) {
  .app-header, .nav-tabs-bottom { display: none !important; }
  #app { padding-bottom: 0 !important; }
  .player-section { position: fixed !important; inset: 0 !important; width: 100% !important; height: 100% !important; border-radius: 0 !important; z-index: 999 !important; margin: 0 !important; }
  .player-section .video-js { height: 100% !important; aspect-ratio: unset !important; border-radius: 0 !important; }
  .player-info, .player-episodes-section { display: none !important; }
}

/* RESPONSIVE */
@media (max-width: 1024px) {
  .main-content { grid-template-columns: 1fr; }
  .sidebar-categories { display: none; position: fixed; left: 0; top: 76px; bottom: 80px; width: 300px; z-index: 99; box-shadow: 10px 0 40px rgba(0,0,0,0.5); }
  .sidebar-categories.show { display: block; animation: slideInLeft 0.3s ease-out; }
  @keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
  .player-section.sticky-player { width: 280px; top: auto; bottom: 90px; right: 0.5rem; }
}
@media (max-width: 768px) {
  .app-header { flex-wrap: wrap; gap: 0.75rem; padding: 0.75rem 1rem; }
  .app-logo { font-size: 1.25rem; }
  .search-box { order: 3; max-width: 100%; width: 100%; }
  .cache-indicator { display: none; }
  .nav-tab span { font-size: 0.65rem; }
  .nav-tab i { font-size: 1.35rem; }
  .content-area { padding: 1rem; }
  .items-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem; }
  .modal-body { padding: 1.25rem; margin-top: -70px; }
  .modal-poster-container { flex-direction: column; align-items: center; text-align: center; }
  .modal-poster { width: 160px; height: 240px; }
  .modal-title { font-size: 1.5rem; }
  .modal-meta, .modal-genres, .modal-actions { justify-content: center; }
  .episodes-grid { grid-template-columns: 1fr; }
  .home-banner { height: 45vh; min-height: 260px; }
  .banner-info h2 { font-size: 1.5rem; }
  .banner-info .banner-desc { display: none; }
  .home-row { padding: 0 1rem; }
  .home-card { width: 130px; }
  .player-section.sticky-player { width: 220px; bottom: 90px; }
}
@media (max-width: 480px) {
  .login-container { padding: 2rem 1.5rem; margin: 1rem; border-radius: var(--radius); }
  .login-header h1 { font-size: 1.5rem; }
  .login-header .logo { font-size: 3rem; }
  .items-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
  .item-info { padding: 0.5rem; }
  .item-title { font-size: 0.8rem; }
  .item-favorite { width: 30px; height: 30px; }
  .play-btn { width: 45px; height: 45px; font-size: 1.2rem; }
  .player-info { padding: 0.75rem 1rem; flex-direction: column; align-items: flex-start; gap: 0.5rem; }
  .home-banner { height: 38vh; min-height: 220px; }
  .banner-info { bottom: 1.5rem; left: 1rem; right: 1rem; }
  .banner-info h2 { font-size: 1.2rem; }
  .home-card { width: 115px; }
  .ver-mais-grid { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
  .player-section.sticky-player { width: 180px; }
}
@media (max-width: 360px) {
  .app-header { padding: 0.5rem 0.75rem; }
  .btn-icon { width: 38px; height: 38px; }
  .nav-tab { padding: 0.5rem 0.75rem; }
}
@media (min-width: 1400px) {
  .items-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
  .modal-content { max-width: 1100px; }
  .modal-backdrop-img { height: 400px; }
}
@media (min-width: 1800px) {
  .items-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
  .content-area { padding: 2rem; }
}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen">
  <div class="login-container">
    <div class="login-header">
      <span class="logo">ðŸ“º</span>
      <h1>9Xtream</h1>
      <p>Premium Streaming Experience</p>
    </div>
    <div class="form-floating">
      <input type="text" class="form-control" id="server" placeholder="Servidor">
      <label>Servidor (ex: servidor.com:8080)</label>
    </div>
    <div class="form-floating">
      <input type="text" class="form-control" id="username" placeholder="UsuÃ¡rio">
      <label>UsuÃ¡rio</label>
    </div>
    <div class="form-floating">
      <input type="password" class="form-control" id="password" placeholder="Senha">
      <label>Senha</label>
    </div>
    <button class="btn-login" id="btnLogin" onclick="login()">
      <i class="bi bi-box-arrow-in-right"></i> Entrar
    </button>
  </div>
</div>

<!-- Main App -->
<div id="app">
  <header class="app-header" id="appHeader">
    <div class="app-logo"><span class="logo-icon">ðŸ“º</span><span>9Xtream</span></div>
    <div class="search-box"><i class="bi bi-search"></i><input type="text" id="search" placeholder="Buscar canais, filmes, sÃ©ries..."></div>
    <div class="cache-indicator" id="cacheIndicator"><span class="dot"></span><span id="cacheStatus">Cache: Inativo</span></div>
    <div class="header-actions">
      <button class="btn-icon" onclick="clearAllCache()" title="Limpar Cache"><i class="bi bi-trash"></i></button>
      <button class="btn-icon" onclick="toggleSidebar()" title="Categorias"><i class="bi bi-list"></i></button>
      <button class="btn-icon" onclick="showAccountModal()" title="Conta"><i class="bi bi-person"></i></button>
      <button class="btn-icon" onclick="logout()" title="Sair"><i class="bi bi-box-arrow-right"></i></button>
    </div>
  </header>

  <!-- HOMEPAGE -->
  <div id="homeSection">
    <div class="home-banner" id="homeBanner"><div id="bannerSlides"></div><div class="banner-dots" id="bannerDots"></div></div>
    <div class="home-row"><div class="home-row-header"><div class="home-row-title"><i class="bi bi-broadcast"></i> Canais ao Vivo</div><button class="btn-ver-mais" onclick="openVerMais('live')">Ver mais <i class="bi bi-chevron-right"></i></button></div><div class="home-row-scroll" id="homeChannelsScroll"></div></div>
    <div class="home-row"><div class="home-row-header"><div class="home-row-title"><i class="bi bi-film"></i> Filmes</div><button class="btn-ver-mais" onclick="openVerMais('movies')">Ver mais <i class="bi bi-chevron-right"></i></button></div><div class="home-row-scroll" id="homeMoviesScroll"></div></div>
    <div class="home-row"><div class="home-row-header"><div class="home-row-title"><i class="bi bi-collection-play"></i> SÃ©ries</div><button class="btn-ver-mais" onclick="openVerMais('series')">Ver mais <i class="bi bi-chevron-right"></i></button></div><div class="home-row-scroll" id="homeSeriesScroll"></div></div>
  </div>

  <!-- MAIN CONTENT (category view) -->
  <div class="main-content" id="mainContent" style="display:none;">
    <aside class="sidebar-categories" id="sidebar"><div class="sidebar-header">Categorias <span class="cache-badge" id="cacheBadge" style="display:none;">CACHED</span></div><div class="category-list" id="categoryList"></div></aside>
    <main class="content-area">
      <div class="player-section" id="playerSection" style="display:none;">
        <button class="sticky-player-close" onclick="closeStickyPlayer()"><i class="bi bi-x"></i></button>
        <video id="player" class="video-js vjs-big-play-centered vjs-fluid"></video>
        <div class="player-info"><div class="now-playing"><div class="now-playing-dot"></div><span class="now-playing-text" id="nowPlaying">Selecione um conteÃºdo</span></div><div class="stream-info" id="streamInfo"></div></div>
        <div class="player-episodes-section" id="playerEpisodesSection"><div class="episodes-header"><div class="episodes-title"><i class="bi bi-collection-play"></i><span id="seriesTitlePlayer">EpisÃ³dios</span></div><div class="seasons-tabs" id="seasonsTabsPlayer"></div></div><div class="episodes-scroll" id="episodesScrollPlayer"></div></div>
      </div>
      <div class="content-header"><h2 class="content-title" id="contentTitle">TV ao Vivo</h2><span class="content-count" id="contentCount"></span></div>
      <div id="content"><div class="loading-container"><div class="loading-spinner"></div><span>Carregando...</span></div></div>
    </main>
  </div>

  <!-- Bottom Nav -->
  <nav class="nav-tabs-bottom">
    <button class="nav-tab active" data-tab="home" onclick="switchTab('home', this)"><i class="bi bi-house-fill"></i><span>InÃ­cio</span></button>
    <button class="nav-tab" data-tab="live" onclick="switchTab('live', this)"><i class="bi bi-broadcast"></i><span>Canais</span></button>
    <button class="nav-tab" data-tab="movies" onclick="switchTab('movies', this)"><i class="bi bi-film"></i><span>Filmes</span></button>
    <button class="nav-tab" data-tab="series" onclick="switchTab('series', this)"><i class="bi bi-collection-play"></i><span>SÃ©ries</span></button>
    <button class="nav-tab" data-tab="fav" onclick="switchTab('fav', this)"><i class="bi bi-heart-fill"></i><span>Favoritos</span></button>
  </nav>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="detailModal">
  <div class="modal-content">
    <div class="modal-header"><img class="modal-backdrop-img" id="modalBackdrop" src="" alt=""><div class="modal-backdrop-gradient"></div><button class="modal-close" onclick="closeModal('detailModal')"><i class="bi bi-x-lg"></i></button></div>
    <div class="modal-body">
      <div class="modal-poster-container">
        <img class="modal-poster" id="modalPoster" src="" alt="">
        <div class="modal-details">
          <h2 class="modal-title" id="modalTitle"></h2>
          <div class="modal-meta" id="modalMeta"></div>
          <div class="modal-genres" id="modalGenres"></div>
          <p class="modal-description" id="modalDescription"></p>
          <div class="modal-cast" id="modalCastSection"><div class="modal-cast-title">Elenco</div><div class="modal-cast-list" id="modalCast"></div></div>
          <div class="modal-actions" id="modalActions"></div>
        </div>
      </div>
      <div class="seasons-section" id="seasonsSection" style="display:none;"><div class="seasons-header"><h3>EpisÃ³dios</h3><select class="season-select" id="seasonSelect" onchange="loadEpisodes()"></select></div><div class="episodes-grid" id="episodesGrid"></div></div>
    </div>
  </div>
</div>

<!-- Account Modal -->
<div class="modal-overlay" id="accountModal">
  <div class="modal-content" style="max-width:480px;">
    <div class="modal-body" style="margin-top:0;padding-top:2rem;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;"><h2 style="margin:0;font-size:1.5rem;font-weight:700;">ðŸ‘¤ Minha Conta</h2><button class="modal-close" style="position:static;" onclick="closeModal('accountModal')"><i class="bi bi-x-lg"></i></button></div>
      <div class="account-info" id="accountInfo"></div>
    </div>
  </div>
</div>

<!-- Ver Mais Overlay -->
<div class="ver-mais-overlay" id="verMaisOverlay">
  <div class="ver-mais-header"><button class="ver-mais-back" onclick="closeVerMais()"><i class="bi bi-arrow-left"></i></button><h2 id="verMaisTitle">Categoria</h2></div>
  <div class="ver-mais-categories" id="verMaisCategories"></div>
  <div class="ver-mais-content" id="verMaisContent"><div class="ver-mais-grid" id="verMaisGrid"></div></div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>

<script>
// ============================================================================
// 9XTREAM PREMIUM IPTV PLAYER - ENHANCED WITH HOMEPAGE
// ============================================================================

// ---------- CONFIGURAÃ‡Ã•ES DE CACHE ----------
const CACHE_CONFIG = {
  CATEGORIES_TTL: 24 * 60 * 60 * 1000,
  ITEMS_TTL: 12 * 60 * 60 * 1000,
  DETAILS_TTL: 24 * 60 * 60 * 1000,
  SESSION_TTL: 7 * 24 * 60 * 60 * 1000,
  PREFIX: 'unitv_cache_',
  VERSION: 'v5'
};

const STREAM_TYPES = {
  HLS: ['m3u8', 'hls'],
  TS: ['ts'],
  MP4: ['mp4', 'mkv', 'avi'],
  M3U: ['m3u'],
  QUALITY: { SD: 'SD', HD: 'HD', FHD: 'FHD', UHD: '4K', '4K': '4K' },
  CODEC: { H264: 'H.264', H265: 'H.265', HEVC: 'HEVC' }
};

// ---------- ESTADO GLOBAL ----------
let API = { base: "", user: "", pass: "" };
let userInfo = {};
let categories = [];
let items = [];
let filteredItems = [];
let favorites = JSON.parse(localStorage.getItem("unitvFav") || "[]");
let player = null;
let hlsInstance = null;
let currentTab = "home";
let currentCategory = null;
let currentSeriesInfo = null;
let currentPlayingSeriesId = null;
let currentPlayingSeason = null;
let currentPlayingEpisodeId = null;
let isLoading = false;
let isPlayerActive = false;
let homeData = { channels: [], movies: [], series: [], bannerItems: [] };
let bannerInterval = null;
let currentBannerIndex = 0;
let verMaisCurrentItems = [];
let verMaisLoadedCount = 0;
const VERMAIS_BATCH = 50;
let verMaisTab = 'live';
let searchDebounceTimer = null;
const SEARCH_DEBOUNCE_MS = 300;

const memoryCache = {
  categories: { live: null, movies: null, series: null },
  items: { live: {}, movies: {}, series: {} },
  details: {},
  lastLoadedCategory: { live: null, movies: null, series: null }
};

// ---------- CACHE ----------
function getCacheKey(t, id = '') {
  return `${CACHE_CONFIG.PREFIX}${CACHE_CONFIG.VERSION}_${t}_${id}`;
}

function setCache(k, d, ttl = CACHE_CONFIG.ITEMS_TTL) {
  try {
    localStorage.setItem(k, JSON.stringify({
      data: d,
      timestamp: Date.now(),
      expires: Date.now() + ttl
    }));
    updateCacheIndicator(true);
  } catch (e) {
    if (e.name === 'QuotaExceededError') {
      cleanOldCache();
      try {
        localStorage.setItem(k, JSON.stringify({
          data: d,
          timestamp: Date.now(),
          expires: Date.now() + ttl
        }));
      } catch (e2) { }
    }
  }
}

function getCache(k) {
  try {
    const c = localStorage.getItem(k);
    if (!c) return null;
    const d = JSON.parse(c);
    if (Date.now() > d.expires) {
      localStorage.removeItem(k);
      return null;
    }
    updateCacheIndicator(true);
    return d.data;
  } catch (e) {
    return null;
  }
}

function getCachedData(t, tab, cid = 'all') {
  const k = cid === 'all' ? 'all' : cid;
  if (t === 'categories' && memoryCache.categories[tab]) return memoryCache.categories[tab];
  if (t === 'items' && memoryCache.items[tab] && memoryCache.items[tab][k]) return memoryCache.items[tab][k];
  const ck = getCacheKey(t, `${tab}_${k}`);
  const ld = getCache(ck);
  if (ld) {
    if (t === 'categories') memoryCache.categories[tab] = ld;
    else if (t === 'items') {
      if (!memoryCache.items[tab]) memoryCache.items[tab] = {};
      memoryCache.items[tab][k] = ld;
    }
    return ld;
  }
  return null;
}

function setCachedData(t, tab, d, cid = 'all', ttl = null) {
  const k = cid === 'all' ? 'all' : cid;
  if (t === 'categories') memoryCache.categories[tab] = d;
  else if (t === 'items') {
    if (!memoryCache.items[tab]) memoryCache.items[tab] = {};
    memoryCache.items[tab][k] = d;
  }
  const ck = getCacheKey(t, `${tab}_${k}`);
  setCache(ck, d, ttl || (t === 'categories' ? CACHE_CONFIG.CATEGORIES_TTL : CACHE_CONFIG.ITEMS_TTL));
}

function updateCacheIndicator(a) {
  const i = document.getElementById('cacheIndicator');
  const s = document.getElementById('cacheStatus');
  const b = document.getElementById('cacheBadge');
  if (a) {
    i.classList.add('active');
    s.textContent = 'Cache: Ativo';
    if (b) b.style.display = 'inline';
  } else {
    i.classList.remove('active');
    s.textContent = 'Cache: Inativo';
    if (b) b.style.display = 'none';
  }
}

function cleanOldCache() {
  Object.keys(localStorage).forEach(k => {
    if (k.startsWith(CACHE_CONFIG.PREFIX)) {
      try {
        const c = JSON.parse(localStorage.getItem(k));
        if (c && c.expires && Date.now() > c.expires) localStorage.removeItem(k);
      } catch (e) {
        localStorage.removeItem(k);
      }
    }
  });
}

function clearAllCache() {
  Object.keys(localStorage).forEach(k => {
    if (k.startsWith(CACHE_CONFIG.PREFIX) || k.startsWith('unitv')) localStorage.removeItem(k);
  });
  memoryCache.categories = { live: null, movies: null, series: null };
  memoryCache.items = { live: {}, movies: {}, series: {} };
  memoryCache.details = {};
  memoryCache.lastLoadedCategory = { live: null, movies: null, series: null };
  updateCacheIndicator(false);
  showToast('Cache limpo!', 'success');
}

// ---------- SESSION ----------
function saveSession(a, u) {
  localStorage.setItem('unitv_session', JSON.stringify({
    api: a,
    user: u,
    timestamp: Date.now()
  }));
}

function restoreSession() {
  try {
    const s = JSON.parse(localStorage.getItem('unitv_session'));
    if (!s) return false;
    if (Date.now() - s.timestamp > CACHE_CONFIG.SESSION_TTL) {
      localStorage.removeItem('unitv_session');
      return false;
    }
    API = s.api;
    userInfo = s.user;
    return true;
  } catch (e) {
    return false;
  }
}

// ---------- UTILS ----------
function showToast(m, t = 'info') {
  const c = document.getElementById('toastContainer');
  const e = document.createElement('div');
  e.className = `toast ${t}`;
  const icons = { success: 'check-circle', error: 'exclamation-circle', info: 'info-circle' };
  e.innerHTML = `<i class="bi bi-${icons[t] || 'info-circle'}"></i><span>${m}</span>`;
  c.appendChild(e);
  setTimeout(() => e.remove(), 4000);
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('show');
}

function unixToDate(ts) {
  if (!ts) return 'N/A';
  return new Date(ts * 1000).toLocaleDateString('pt-BR');
}

async function fetchWithTimeout(u, o = {}, t = 15000) {
  const c = new AbortController();
  const id = setTimeout(() => c.abort(), t);
  try {
    const r = await fetch(u, { ...o, signal: c.signal });
    clearTimeout(id);
    return r;
  } catch (e) {
    clearTimeout(id);
    throw e;
  }
}

async function fetchWithRetry(u, o = {}, r = 3) {
  for (let i = 0; i < r; i++) {
    try {
      return await fetchWithTimeout(u, o);
    } catch (e) {
      if (i === r - 1) throw e;
      await new Promise(res => setTimeout(res, 1000 * (i + 1)));
    }
  }
}

function generateStreamBadges(item, ext) {
  let b = [];
  const n = (item.name || '').toLowerCase();
  if (ext) {
    if (STREAM_TYPES.HLS.includes(ext)) b.push('<span class="stream-badge hls">HLS</span>');
    else if (STREAM_TYPES.TS.includes(ext)) b.push('<span class="stream-badge ts">TS</span>');
    else if (STREAM_TYPES.MP4.includes(ext)) b.push('<span class="stream-badge mp4">MP4</span>');
  }
  if (n.includes('4k') || n.includes('uhd')) b.push('<span class="stream-badge uhd">4K</span>');
  else if (n.includes('fhd') || n.includes('1080')) b.push('<span class="stream-badge fhd">FHD</span>');
  else if (n.includes(' hd') || n.includes('[hd]') || n.includes('720')) b.push('<span class="stream-badge hd">HD</span>');
  if (n.includes('h265') || n.includes('hevc')) b.push('<span class="stream-badge h265">H.265</span>');
  else if (n.includes('h264')) b.push('<span class="stream-badge h264">H.264</span>');
  return b.length > 0 ? `<div class="stream-type-badge">${b.join('')}</div>` : '';
}

// ---------- SKELETON ----------
function createSkeletonCards(c, live = false) {
  let h = '';
  for (let i = 0; i < c; i++) {
    h += `<div class="skeleton-card ${live ? 'live' : ''}">
      <div class="skel-img"></div>
      <div class="skel-text"><div class="skel-line"></div></div>
    </div>`;
  }
  return h;
}

function createSkeletonGrid(c) {
  let h = '';
  for (let i = 0; i < c; i++) {
    h += `<div class="item-skeleton">
      <div class="skeleton-poster"></div>
      <div class="skeleton-info"><div class="skeleton-title"></div></div>
    </div>`;
  }
  return h;
}

// ---------- CREATE ITEM CARD ----------
function createItemCard(item) {
  const isLive = currentTab === 'live';
  const isSeries = currentTab === 'series';
  const img = item.stream_icon || item.cover || `https://via.placeholder.com/300x450/1a1a25/606070?text=${isLive ? 'ðŸ“º' : 'ðŸŽ¬'}`;
  const ext = item.container_extension || '';
  const favId = item.stream_id || item.series_id;
  const favName = (item.name || '').replace(/'/g, "\\'");
  const favIcon = (item.stream_icon || item.cover || '').replace(/'/g, "\\'");
  const favType = isSeries ? 'series' : (currentTab === 'movies' ? 'movies' : 'live');
  const isFav = favorites.some(f => f.id == favId);

  const card = document.createElement('div');
  card.className = 'item-card';
  card.innerHTML = `
    <img class="item-poster ${isLive ? 'item-poster-live' : ''}" 
         src="${img}" alt="${item.name || ''}" loading="lazy"
         onerror="this.src='https://via.placeholder.com/300x450/1a1a25/606070?text=ðŸ“º'">
    <button class="item-favorite ${isFav ? 'active' : ''}" 
            onclick="event.stopPropagation();toggleFav(${favId},'${favName}','${favIcon}','${favType}')">
      <i class="bi bi-heart-fill"></i>
    </button>
    ${generateStreamBadges(item, ext)}
    <div class="item-play-overlay">
      <div class="play-btn"><i class="bi bi-play-fill"></i></div>
    </div>
    <div class="item-info">
      <div class="item-title">${item.name || ''}</div>
      <div class="item-meta">
        ${item.rating ? `<span>â­ ${parseFloat(item.rating).toFixed(1)}</span>` : ''}
        ${item.year ? `<span>${item.year}</span>` : ''}
      </div>
    </div>
  `;
  card.onclick = () => handleItemClick(item);
  return card;
}

// ---------- PROGRESSIVE SCROLL ----------
let progressiveList = [];
let progressiveLoaded = 0;
const PROGRESSIVE_BATCH = 50;
let progressiveScrollBound = null;

function setupProgressiveScroll(list) {
  progressiveList = list;
  progressiveLoaded = 0;
  const c = document.getElementById('content');

  // Remove old listener if exists
  if (progressiveScrollBound) {
    c.removeEventListener('scroll', progressiveScrollBound);
    window.removeEventListener('scroll', progressiveScrollBound);
  }

  c.innerHTML = '<div class="items-grid" id="itemsGrid"></div>';
  loadProgressiveBatch();

  progressiveScrollBound = progressiveScrollHandler;
  c.addEventListener('scroll', progressiveScrollBound);
  window.addEventListener('scroll', progressiveScrollBound);
}

function progressiveScrollHandler() {
  const g = document.getElementById('itemsGrid');
  if (!g || progressiveLoaded >= progressiveList.length) return;
  const rect = g.getBoundingClientRect();
  const bottomVisible = rect.bottom - window.innerHeight < 400;
  const c = document.getElementById('content');
  const contentScroll = c.scrollTop + c.clientHeight >= c.scrollHeight - 400;
  if (bottomVisible || contentScroll) {
    loadProgressiveBatch();
  }
}

function loadProgressiveBatch() {
  const g = document.getElementById('itemsGrid');
  if (!g || progressiveLoaded >= progressiveList.length) return;
  const batch = progressiveList.slice(progressiveLoaded, progressiveLoaded + PROGRESSIVE_BATCH);
  progressiveLoaded += batch.length;
  const f = document.createDocumentFragment();
  batch.forEach(i => f.appendChild(createItemCard(i)));
  g.appendChild(f);
}

// ---------- RENDER ITEMS ----------
function renderItems(list) {
  const c = document.getElementById('content');
  document.getElementById('contentCount').textContent = `${list.length} itens`;

  if (list.length === 0) {
    c.innerHTML = `<div class="empty-state">
      <i class="bi bi-inbox"></i>
      <h3>Nenhum item encontrado</h3>
      <p>Tente uma busca diferente.</p>
    </div>`;
    return;
  }

  if (list.length > PROGRESSIVE_BATCH) {
    setupProgressiveScroll(list);
    return;
  }

  const f = document.createDocumentFragment();
  const g = document.createElement('div');
  g.className = 'items-grid';
  list.forEach(i => g.appendChild(createItemCard(i)));
  f.appendChild(g);
  c.innerHTML = '';
  c.appendChild(f);
}

// ---------- PLAYER ----------
function initPlayer() {
  if (player) return;
  player = videojs('player', {
    controls: true,
    autoplay: false,
    preload: 'auto',
    fluid: true,
    html5: {
      vhs: {
        overrideNative: true,
        enableLowInitialPlaylist: true,
        smoothQualityChange: true,
        fastQualityChange: true
      }
    },
    liveui: true
  });
  player.on('error', () => showToast('Erro ao reproduzir.', 'error'));
}

function playStream(url, type, name) {
  initPlayer();
  if (hlsInstance) {
    hlsInstance.destroy();
    hlsInstance = null;
  }
  const isHLS = url.includes('.m3u8') || type === 'hls';
  updateStreamInfo(url);
  isPlayerActive = true;

  if (isHLS) {
    if (Hls.isSupported()) {
      hlsInstance = new Hls({
        maxBufferLength: 30,
        maxMaxBufferLength: 60,
        maxBufferSize: 60 * 1000 * 1000,
        maxBufferHole: 0.5,
        lowLatencyMode: true,
        enableWorker: true,
        startLevel: -1
      });
      const ve = document.querySelector('#player video') || document.getElementById('player');
      hlsInstance.loadSource(url);
      hlsInstance.attachMedia(ve);
      hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
        player.play().catch(() => { player.muted(true); player.play(); });
      });
      hlsInstance.on(Hls.Events.ERROR, (e, d) => {
        if (d.fatal) {
          showToast('Erro no stream.', 'error');
          hlsInstance.startLoad();
        }
      });
    } else {
      player.src({ src: url, type: 'application/x-mpegURL' });
      player.play().catch(() => { player.muted(true); player.play(); });
    }
  } else {
    const isTS = url.includes('.ts');
    player.src({ src: url, type: isTS ? 'video/mp2t' : 'video/mp4' });
    player.play().catch(() => { player.muted(true); player.play(); });
  }

  document.getElementById('nowPlaying').textContent = name;
  document.getElementById('playerSection').style.display = 'block';
  document.getElementById('playerSection').scrollIntoView({ behavior: 'smooth' });
}

function updateStreamInfo(url) {
  const s = document.getElementById('streamInfo');
  const b = [];
  if (url.includes('.m3u8')) b.push('<span class="stream-badge hls">HLS</span>');
  if (url.includes('.ts')) b.push('<span class="stream-badge ts">TS</span>');
  if (url.includes('.mp4')) b.push('<span class="stream-badge mp4">MP4</span>');
  s.innerHTML = b.join('');
}

function closeStickyPlayer() {
  document.getElementById('playerSection').classList.remove('sticky-player');
  if (player) player.pause();
  isPlayerActive = false;
}

// ---------- LOGIN ----------
async function login() {
  const sv = document.getElementById("server").value.trim();
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();

  if (!sv || !u || !p) {
    showToast("Preencha todos os campos", "error");
    return;
  }

  const btn = document.getElementById("btnLogin");
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Conectando...';

  let server = sv.replace(/^https?:\/\//, '').replace(/\/$/, '');
  let connected = false;
  let data = null;

  for (const proto of ['http', 'https']) {
    if (connected) break;
    try {
      const res = await fetchWithTimeout(
        `${proto}://${server}/player_api.php?username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`,
        {},
        15000
      );
      data = await res.json();
      if (data.user_info && data.user_info.auth == 1) {
        API = { base: `${proto}://${server}`, user: u, pass: p };
        connected = true;
      }
    } catch (e) { }
  }

  if (!connected) {
    showToast("Erro ao conectar.", "error");
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Entrar';
    return;
  }

  userInfo = data.user_info;
  localStorage.setItem('unitvCredentials', JSON.stringify({ server, user: u, pass: p }));
  saveSession(API, userInfo);
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("app").style.display = "block";
  showToast("Login realizado!", "success");
  loadHomepage();
}

function logout() {
  if (player) {
    player.pause();
    player.dispose();
    player = null;
  }
  if (hlsInstance) {
    hlsInstance.destroy();
    hlsInstance = null;
  }
  if (bannerInterval) clearInterval(bannerInterval);
  clearAllCache();
  localStorage.removeItem('unitvCredentials');
  localStorage.removeItem('unitv_session');
  localStorage.removeItem('unitvFav');
  API = { base: '', user: '', pass: '' };
  userInfo = {};
  categories = [];
  items = [];
  filteredItems = [];
  favorites = [];
  currentTab = 'home';
  currentCategory = null;
  currentSeriesInfo = null;
  isPlayerActive = false;
  homeData = { channels: [], movies: [], series: [], bannerItems: [] };
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('server').value = '';
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  document.getElementById('search').value = '';
}

function showAccountModal() {
  const i = document.getElementById('accountInfo');
  i.innerHTML = `
    <div class="account-row"><span class="account-label">Servidor</span><span class="account-value">${API.base}</span></div>
    <div class="account-row"><span class="account-label">UsuÃ¡rio</span><span class="account-value">${API.user}</span></div>
    <div class="account-row"><span class="account-label">Status</span><span class="account-value ${userInfo.status === 'Active' ? 'status-active' : 'status-expired'}">${userInfo.status}</span></div>
    <div class="account-row"><span class="account-label">Expira em</span><span class="account-value">${unixToDate(userInfo.exp_date)}</span></div>
    <div class="account-row"><span class="account-label">ConexÃµes</span><span class="account-value">${userInfo.active_cons || 0} / ${userInfo.max_connections || 'âˆž'}</span></div>
  `;
  document.getElementById('accountModal').classList.add('show');
}

// ---------- TAB NAV ----------
function switchTab(tab, el) {
  if (currentTab === tab && tab !== 'home') return;
  document.querySelectorAll(".nav-tab").forEach(b => b.classList.remove("active"));
  el.classList.add("active");
  currentTab = tab;
  currentCategory = null;
  hidePlayerEpisodes();

  if (tab === 'home') {
    document.getElementById('homeSection').style.display = 'block';
    document.getElementById('mainContent').style.display = 'none';
    if (!homeData.bannerItems.length) loadHomepage();
    return;
  }

  document.getElementById('homeSection').style.display = 'none';
  document.getElementById('mainContent').style.display = 'grid';

  const titles = { live: 'TV ao Vivo', movies: 'Filmes', series: 'SÃ©ries', fav: 'Favoritos' };
  document.getElementById('contentTitle').textContent = titles[tab];

  if (!isPlayerActive) document.getElementById('playerSection').style.display = 'none';

  // Tenta restaurar do cache
  const cc = getCachedData('categories', tab);
  const lc = memoryCache.lastLoadedCategory[tab];
  const ci = lc ? getCachedData('items', tab, lc) : null;
  if (cc && ci && ci.length > 0) {
    categories = cc;
    items = ci;
    filteredItems = items;
    currentCategory = lc;
    renderCategories();
    renderItems(items);
    return;
  }

  loadTab();
}

// ---------- HOMEPAGE ----------
async function loadHomepage() {
  const cs = document.getElementById('homeChannelsScroll');
  const ms = document.getElementById('homeMoviesScroll');
  const ss = document.getElementById('homeSeriesScroll');

  cs.innerHTML = createSkeletonCards(10, true);
  ms.innerHTML = createSkeletonCards(10);
  ss.innerHTML = createSkeletonCards(10);

  try {
    const [lc, mc, sc] = await Promise.all([
      fetchCatsForTab('live'),
      fetchCatsForTab('movies'),
      fetchCatsForTab('series')
    ]);

    const [li, mi, si] = await Promise.all([
      fetchHomeItems('live', lc),
      fetchHomeItems('movies', mc),
      fetchHomeItems('series', sc)
    ]);

    homeData.channels = li;
    homeData.movies = mi;
    homeData.series = si;

    // Banner com filmes e sÃ©ries mais bem avaliados
    homeData.bannerItems = [...mi, ...si]
      .filter(i => (i.stream_icon || i.cover))
      .sort((a, b) => parseFloat(b.rating || 0) - parseFloat(a.rating || 0))
      .slice(0, 10);

    if (homeData.bannerItems.length === 0) {
      homeData.bannerItems = [...mi, ...si].filter(i => i.stream_icon || i.cover).slice(0, 10);
    }

    renderBanner();
    renderHomeRow(cs, li, 'live');
    renderHomeRow(ms, mi, 'movies');
    renderHomeRow(ss, si, 'series');
  } catch (e) {
    console.error('Homepage error:', e);
    cs.innerHTML = ms.innerHTML = ss.innerHTML = '<span style="color:var(--text-muted);padding:1rem;">Erro ao carregar</span>';
  }
}

async function fetchCatsForTab(tab) {
  let c = getCachedData('categories', tab);
  if (c) return c;
  const acts = { live: 'get_live_categories', movies: 'get_vod_categories', series: 'get_series_categories' };
  const r = await fetchWithRetry(`${API.base}/player_api.php?username=${API.user}&password=${API.pass}&action=${acts[tab]}`);
  const d = await r.json();
  const a = Array.isArray(d) ? d : [];
  setCachedData('categories', tab, a);
  return a;
}

async function fetchHomeItems(tab, cats) {
  const sel = cats.slice(0, 5);
  const all = [];
  const acts = { live: 'get_live_streams', movies: 'get_vod_streams', series: 'get_series' };

  for (const cat of sel) {
    if (all.length >= 10) break;
    let ci = getCachedData('items', tab, cat.category_id);
    if (!ci) {
      try {
        const r = await fetchWithRetry(`${API.base}/player_api.php?username=${API.user}&password=${API.pass}&action=${acts[tab]}&category_id=${cat.category_id}`);
        ci = await r.json();
        if (!Array.isArray(ci)) ci = [];
        setCachedData('items', tab, ci, cat.category_id);
      } catch (e) {
        continue;
      }
    }
    const need = 10 - all.length;
    ci.slice(0, Math.min(need, 2)).forEach(i => {
      i._categoryName = cat.category_name;
      all.push(i);
    });
  }

  return all.slice(0, 10);
}

// ---------- BANNER ----------
function renderBanner() {
  const sc = document.getElementById('bannerSlides');
  const dc = document.getElementById('bannerDots');

  if (!homeData.bannerItems.length) {
    document.getElementById('homeBanner').style.display = 'none';
    return;
  }

  sc.innerHTML = homeData.bannerItems.map((item, i) => `
    <div class="banner-slide ${i === 0 ? 'active' : ''}" data-index="${i}">
      <img src="${item.stream_icon || item.cover || ''}" alt="${item.name || ''}" onerror="this.style.display='none'">
      <div class="banner-gradient"></div>
      <div class="banner-info">
        <h2>${item.name || ''}</h2>
        <div class="banner-meta">
          ${item.year ? `<span><i class="bi bi-calendar"></i> ${item.year}</span>` : ''}
          ${item.rating ? `<span>â­ ${parseFloat(item.rating).toFixed(1)}</span>` : ''}
          ${item._categoryName ? `<span>${item._categoryName}</span>` : ''}
        </div>
        ${item.plot ? `<div class="banner-desc">${item.plot}</div>` : ''}
        <div class="banner-actions">
          <button class="btn-play" onclick="bannerPlay(${i})"><i class="bi bi-play-fill"></i> Assistir</button>
          <button class="btn-secondary" onclick="bannerDetails(${i})"><i class="bi bi-info-circle"></i> Detalhes</button>
        </div>
      </div>
    </div>
  `).join('');

  dc.innerHTML = homeData.bannerItems.map((_, i) => `
    <button class="banner-dot ${i === 0 ? 'active' : ''}" onclick="goToBannerSlide(${i})"></button>
  `).join('');

  if (bannerInterval) clearInterval(bannerInterval);
  bannerInterval = setInterval(() => {
    goToBannerSlide((currentBannerIndex + 1) % homeData.bannerItems.length);
  }, 6000);
}

function goToBannerSlide(i) {
  currentBannerIndex = i;
  document.querySelectorAll('.banner-slide').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.banner-dot').forEach(d => d.classList.remove('active'));
  const sl = document.querySelector(`.banner-slide[data-index="${i}"]`);
  const dt = document.querySelectorAll('.banner-dot')[i];
  if (sl) sl.classList.add('active');
  if (dt) dt.classList.add('active');
}

function bannerPlay(i) {
  const item = homeData.bannerItems[i];
  if (item.series_id) {
    showSeriesDetails(item);
  } else if (item.stream_id) {
    document.getElementById('homeSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'grid';
    currentTab = 'movies';
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-tab="movies"]').classList.add('active');
    playMovie(item.stream_id, item.container_extension || 'mp4');
  }
}

function bannerDetails(i) {
  const item = homeData.bannerItems[i];
  if (item.series_id) showSeriesDetails(item);
  else showMovieDetails(item);
}

function renderHomeRow(c, items, tab) {
  if (!items.length) {
    c.innerHTML = '<span style="color:var(--text-muted);padding:1rem;">Nenhum conteÃºdo</span>';
    return;
  }
  const isLive = tab === 'live';
  c.innerHTML = items.map(item => {
    const img = item.stream_icon || item.cover || `https://via.placeholder.com/300x450/1a1a25/606070?text=${isLive ? 'ðŸ“º' : 'ðŸŽ¬'}`;
    return `<div class="home-card ${isLive ? 'live-card' : ''}" onclick='homeCardClick(${JSON.stringify(item).replace(/'/g, "&#39;")}, "${tab}")'>
      <img src="${img}" alt="${item.name || ''}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450/1a1a25/606070?text=ðŸ“º'">
      <div class="home-card-play"><i class="bi bi-play-fill"></i></div>
      <div class="home-card-info">
        <div class="home-card-title">${item.name || ''}</div>
        ${item._categoryName ? `<div class="home-card-meta">${item._categoryName}</div>` : ''}
      </div>
    </div>`;
  }).join('');
}

function homeCardClick(item, tab) {
  if (tab === 'live') {
    document.getElementById('homeSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'grid';
    currentTab = 'live';
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-tab="live"]').classList.add('active');
    document.getElementById('contentTitle').textContent = 'TV ao Vivo';
    playLiveChannel(item);
  } else if (tab === 'movies') {
    showMovieDetails(item);
  } else {
    showSeriesDetails(item);
  }
}

// ---------- VER MAIS ----------
async function openVerMais(tab) {
  verMaisTab = tab;
  verMaisLoadedCount = 0;
  verMaisCurrentItems = [];
  const titles = { live: 'Canais ao Vivo', movies: 'Filmes', series: 'SÃ©ries' };
  document.getElementById('verMaisTitle').textContent = titles[tab];
  document.getElementById('verMaisOverlay').classList.add('show');

  const cats = await fetchCatsForTab(tab);
  document.getElementById('verMaisCategories').innerHTML = cats.map((c, i) =>
    `<button class="ver-mais-cat-btn ${i === 0 ? 'active' : ''}" onclick="verMaisSelCat('${c.category_id}', this)">${c.category_name}</button>`
  ).join('');

  if (cats.length > 0) await verMaisLoadCat(cats[0].category_id);

  const ce = document.getElementById('verMaisContent');
  ce.onscroll = () => {
    if (ce.scrollTop + ce.clientHeight >= ce.scrollHeight - 200) {
      verMaisLoadMore();
    }
  };
}

function closeVerMais() {
  document.getElementById('verMaisOverlay').classList.remove('show');
}

async function verMaisSelCat(id, el) {
  document.querySelectorAll('.ver-mais-cat-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  await verMaisLoadCat(id);
}

async function verMaisLoadCat(id) {
  const g = document.getElementById('verMaisGrid');
  g.innerHTML = createSkeletonGrid(12);

  const acts = { live: 'get_live_streams', movies: 'get_vod_streams', series: 'get_series' };
  let ci = getCachedData('items', verMaisTab, id);

  if (!ci) {
    try {
      const r = await fetchWithRetry(`${API.base}/player_api.php?username=${API.user}&password=${API.pass}&action=${acts[verMaisTab]}&category_id=${id}`);
      ci = await r.json();
      if (!Array.isArray(ci)) ci = [];
      setCachedData('items', verMaisTab, ci, id);
    } catch (e) {
      g.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:2rem;">Erro ao carregar</p>';
      return;
    }
  }

  verMaisCurrentItems = ci;
  verMaisLoadedCount = 0;
  g.innerHTML = '';
  verMaisLoadMore();
}

function verMaisLoadMore() {
  if (verMaisLoadedCount >= verMaisCurrentItems.length) return;
  const g = document.getElementById('verMaisGrid');
  const batch = verMaisCurrentItems.slice(verMaisLoadedCount, verMaisLoadedCount + VERMAIS_BATCH);
  verMaisLoadedCount += batch.length;
  const isLive = verMaisTab === 'live';

  batch.forEach(item => {
    const img = item.stream_icon || item.cover || `https://via.placeholder.com/300x450/1a1a25/606070?text=${isLive ? 'ðŸ“º' : 'ðŸŽ¬'}`;
    const card = document.createElement('div');
    card.className = 'item-card';
    card.innerHTML = `
      <img class="item-poster ${isLive ? 'item-poster-live' : ''}" src="${img}" alt="${item.name || ''}" loading="lazy"
           onerror="this.src='https://via.placeholder.com/300x450/1a1a25/606070?text=ðŸ“º'">
      <div class="item-play-overlay"><div class="play-btn"><i class="bi bi-play-fill"></i></div></div>
      <div class="item-info"><div class="item-title">${item.name || ''}</div></div>
    `;
    card.onclick = () => {
      closeVerMais();
      if (verMaisTab === 'live') {
        document.getElementById('homeSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'grid';
        currentTab = 'live';
        playLiveChannel(item);
      } else if (verMaisTab === 'movies') {
        showMovieDetails(item);
      } else {
        showSeriesDetails(item);
      }
    };
    g.appendChild(card);
  });
}

// ---------- CONTENT LOADING ----------
async function loadTab() {
  if (isLoading) return;
  const content = document.getElementById("content");
  const cl = document.getElementById("categoryList");

  if (!getCachedData('categories', currentTab)) {
    content.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><span>Carregando...</span></div>';
    cl.innerHTML = '';
  }

  if (currentTab === "fav") {
    categories = [];
    items = favorites.map(f => ({
      stream_id: f.id,
      series_id: f.id,
      name: f.name,
      stream_icon: f.icon,
      cover: f.icon,
      type: f.type
    }));
    filteredItems = items;
    renderCategories();
    renderItems(items);
    return;
  }

  isLoading = true;
  try {
    let ca = 'get_live_categories';
    let ia = 'get_live_streams';
    if (currentTab === 'movies') { ca = 'get_vod_categories'; ia = 'get_vod_streams'; }
    else if (currentTab === 'series') { ca = 'get_series_categories'; ia = 'get_series'; }

    let cats = getCachedData('categories', currentTab);
    if (!cats) {
      const cr = await fetchWithRetry(`${API.base}/player_api.php?username=${API.user}&password=${API.pass}&action=${ca}`);
      cats = await cr.json();
      if (!Array.isArray(cats)) cats = [];
      setCachedData('categories', currentTab, cats);
    }
    categories = cats;
    renderCategories();

    if (categories.length > 0) {
      await loadCategoryItems(categories[0].category_id, true);
    } else {
      let ci = getCachedData('items', currentTab, 'all');
      if (!ci) {
        const ir = await fetchWithRetry(`${API.base}/player_api.php?username=${API.user}&password=${API.pass}&action=${ia}`);
        ci = await ir.json();
        if (!Array.isArray(ci)) ci = [];
        setCachedData('items', currentTab, ci, 'all');
      }
      items = ci;
      filteredItems = items;
      renderItems(items);
    }
  } catch (e) {
    console.error('Error:', e);
    content.innerHTML = `<div class="empty-state">
      <i class="bi bi-exclamation-triangle"></i>
      <h3>Erro ao carregar</h3>
      <button class="btn-play" onclick="loadTab()" style="margin-top:1rem;">
        <i class="bi bi-arrow-clockwise"></i> Tentar novamente
      </button>
    </div>`;
  } finally {
    isLoading = false;
  }
}

async function loadCategoryItems(cid, first = false) {
  if (isLoading && !first) return;
  const content = document.getElementById("content");

  // Tenta do cache primeiro
  const ci = getCachedData('items', currentTab, cid);
  if (ci && ci.length > 0) {
    items = ci;
    filteredItems = items;
    currentCategory = cid;
    memoryCache.lastLoadedCategory[currentTab] = cid;
    renderItems(items);
    updateCategoryActive(cid);
    return;
  }

  content.innerHTML = `<div class="items-grid">${createSkeletonGrid(12)}</div>`;

  let action = 'get_live_streams';
  if (currentTab === 'movies') action = 'get_vod_streams';
  if (currentTab === 'series') action = 'get_series';

  isLoading = true;
  try {
    const r = await fetchWithRetry(`${API.base}/player_api.php?username=${API.user}&password=${API.pass}&action=${action}&category_id=${cid}`);
    const d = await r.json();
    items = Array.isArray(d) ? d : [];
    setCachedData('items', currentTab, items, cid);
    memoryCache.lastLoadedCategory[currentTab] = cid;
    currentCategory = cid;
    filteredItems = items;
    renderItems(items);
    updateCategoryActive(cid);
  } catch (e) {
    showToast('Erro ao carregar', 'error');
    content.innerHTML = '<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><h3>Erro</h3></div>';
  } finally {
    isLoading = false;
  }
}

function updateCategoryActive(cid) {
  document.querySelectorAll('.category-item').forEach(c => {
    c.classList.remove('active');
    if (c.dataset.catId == cid) c.classList.add('active');
  });
}

function renderCategories() {
  const cl = document.getElementById("categoryList");
  cl.innerHTML = '';
  categories.forEach((cat, i) => {
    const el = document.createElement('div');
    el.className = `category-item ${i === 0 && !currentCategory ? 'active' : ''} ${currentCategory == cat.category_id ? 'active' : ''}`;
    el.dataset.catId = cat.category_id;
    el.innerHTML = `<span>${cat.category_name}</span>`;
    el.onclick = () => selectCategory(cat.category_id, el);
    cl.appendChild(el);
  });
}

function selectCategory(cid, el) {
  document.querySelectorAll('.category-item').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  currentCategory = cid;
  loadCategoryItems(cid);
  if (window.innerWidth <= 1024) document.getElementById('sidebar').classList.remove('show');
}

// ---------- ITEM HANDLERS ----------
async function handleItemClick(item) {
  if (currentTab === 'live') playLiveChannel(item);
  else if (currentTab === 'movies') await showMovieDetails(item);
  else if (currentTab === 'series') await showSeriesDetails(item);
  else if (currentTab === 'fav') {
    if (item.type === 'series') await showSeriesDetails(item);
    else if (item.type === 'movies') await showMovieDetails(item);
    else playLiveChannel(item);
  }
}

function playLiveChannel(item) {
  hidePlayerEpisodes();
  document.getElementById('playerSection').style.display = 'block';
  playStream(`${API.base}/live/${API.user}/${API.pass}/${item.stream_id}.m3u8`, 'hls', item.name);
}

// ---------- MOVIE DETAILS ----------
async function showMovieDetails(item) {
  const m = document.getElementById('detailModal');
  document.getElementById('modalPoster').src = item.stream_icon || item.cover || '';
  document.getElementById('modalBackdrop').src = item.stream_icon || item.cover || '';
  document.getElementById('modalTitle').textContent = item.name || '';
  document.getElementById('modalDescription').textContent = 'Carregando...';
  document.getElementById('modalMeta').innerHTML = '';
  document.getElementById('modalGenres').innerHTML = '';
  document.getElementById('modalCast').textContent = '';
  document.getElementById('seasonsSection').style.display = 'none';
  m.classList.add('show');

  try {
    const ck = getCacheKey('movie_detail', item.stream_id);
    let d = getCache(ck) || memoryCache.details[`movie_${item.stream_id}`];
    if (!d) {
      const r = await fetchWithRetry(`${API.base}/player_api.php?username=${API.user}&password=${API.pass}&action=get_vod_info&vod_id=${item.stream_id}`);
      d = await r.json();
      setCache(ck, d, CACHE_CONFIG.DETAILS_TTL);
      memoryCache.details[`movie_${item.stream_id}`] = d;
    }

    const info = d.info || {};
    const md = d.movie_data || item;

    if (info.backdrop_path && info.backdrop_path.length > 0) {
      document.getElementById('modalBackdrop').src = info.backdrop_path[0];
    }
    if (info.cover_big || info.movie_image) {
      document.getElementById('modalPoster').src = info.cover_big || info.movie_image;
    }

    let mh = '';
    if (info.releasedate || info.release_date || md.year)
      mh += `<span><i class="bi bi-calendar"></i> ${info.releasedate || info.release_date || md.year}</span>`;
    if (info.duration) mh += `<span><i class="bi bi-clock"></i> ${info.duration}</span>`;
    if (info.rating) mh += `<span class="modal-rating"><i class="bi bi-star-fill"></i> ${parseFloat(info.rating).toFixed(1)}</span>`;
    if (info.country) mh += `<span><i class="bi bi-globe"></i> ${info.country}</span>`;
    document.getElementById('modalMeta').innerHTML = mh;

    if (info.genre) {
      document.getElementById('modalGenres').innerHTML = info.genre.split(/[,\/]/).map(g =>
        `<span class="genre-tag">${g.trim()}</span>`
      ).join('');
    }

    document.getElementById('modalDescription').textContent = info.description || info.plot || 'Sem descriÃ§Ã£o.';

    if (info.cast || info.actors) {
      document.getElementById('modalCastSection').style.display = 'block';
      document.getElementById('modalCast').textContent = info.cast || info.actors;
    } else {
      document.getElementById('modalCastSection').style.display = 'none';
    }

    const ext = md.container_extension || 'mp4';
    document.getElementById('modalActions').innerHTML = `
      <button class="btn-play" onclick="playMovie(${item.stream_id},'${ext}')"><i class="bi bi-play-fill"></i> Assistir</button>
      <button class="btn-secondary" onclick="toggleFavFromModal(${item.stream_id},'${(item.name || '').replace(/'/g, "\\'")}','${(item.stream_icon || item.cover || '').replace(/'/g, "\\'")}','movies')">
        <i class="bi bi-heart"></i> Favoritar
      </button>
    `;
  } catch (e) {
    document.getElementById('modalDescription').textContent = 'Erro ao carregar detalhes.';
    document.getElementById('modalActions').innerHTML = `
      <button class="btn-play" onclick="playMovie(${item.stream_id},'${item.container_extension || 'mp4'}')"><i class="bi bi-play-fill"></i> Assistir</button>
    `;
  }
}

function playMovie(sid, ext = 'mp4') {
  closeModal('detailModal');
  hidePlayerEpisodes();
  if (currentTab === 'home') {
    document.getElementById('homeSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'grid';
    currentTab = 'movies';
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-tab="movies"]').classList.add('active');
    document.getElementById('contentTitle').textContent = 'Filmes';
  }
  document.getElementById('playerSection').style.display = 'block';
  playStream(`${API.base}/movie/${API.user}/${API.pass}/${sid}.${ext}`, ext === 'mp4' || ext === 'mkv' ? 'mp4' : 'hls', 'Filme');
}

// ---------- SERIES DETAILS ----------
async function showSeriesDetails(item) {
  const m = document.getElementById('detailModal');
  document.getElementById('modalPoster').src = item.cover || '';
  document.getElementById('modalBackdrop').src = item.cover || '';
  document.getElementById('modalTitle').textContent = item.name || '';
  document.getElementById('modalDescription').textContent = 'Carregando...';
  document.getElementById('modalMeta').innerHTML = '';
  document.getElementById('modalGenres').innerHTML = '';
  document.getElementById('modalCast').textContent = '';
  document.getElementById('seasonsSection').style.display = 'none';
  document.getElementById('modalActions').innerHTML = '';
  m.classList.add('show');

  try {
    const ck = getCacheKey('series_detail', item.series_id);
    let d = getCache(ck) || memoryCache.details[`series_${item.series_id}`];
    if (!d) {
      const r = await fetchWithRetry(`${API.base}/player_api.php?username=${API.user}&password=${API.pass}&action=get_series_info&series_id=${item.series_id}`);
      d = await r.json();
      setCache(ck, d, CACHE_CONFIG.DETAILS_TTL);
      memoryCache.details[`series_${item.series_id}`] = d;
    }

    currentSeriesInfo = d;
    currentPlayingSeriesId = item.series_id;
    const info = d.info || item;
    const eps = d.episodes || {};

    if (info.backdrop_path && info.backdrop_path.length > 0) {
      document.getElementById('modalBackdrop').src = info.backdrop_path[0];
    }
    if (info.cover) document.getElementById('modalPoster').src = info.cover;

    let mh = '';
    if (info.releaseDate || info.release_date || item.year)
      mh += `<span><i class="bi bi-calendar"></i> ${info.releaseDate || info.release_date || item.year}</span>`;
    if (info.episode_run_time)
      mh += `<span><i class="bi bi-clock"></i> ${info.episode_run_time} min/ep</span>`;
    if (info.rating || item.rating)
      mh += `<span class="modal-rating"><i class="bi bi-star-fill"></i> ${parseFloat(info.rating || item.rating).toFixed(1)}</span>`;
    document.getElementById('modalMeta').innerHTML = mh;

    const genre = info.genre || item.genre;
    if (genre) {
      document.getElementById('modalGenres').innerHTML = genre.split(/[,\/]/).map(g =>
        `<span class="genre-tag">${g.trim()}</span>`
      ).join('');
    }

    document.getElementById('modalDescription').textContent = info.plot || item.plot || 'Sem descriÃ§Ã£o.';

    const cast = info.cast || item.cast;
    if (cast) {
      document.getElementById('modalCastSection').style.display = 'block';
      document.getElementById('modalCast').textContent = cast;
    } else {
      document.getElementById('modalCastSection').style.display = 'none';
    }

    const sk = Object.keys(eps).sort((a, b) => parseInt(a) - parseInt(b));

    document.getElementById('modalActions').innerHTML = `
      <button class="btn-play" onclick="playFirstEpisode()"><i class="bi bi-play-fill"></i> Assistir</button>
      <button class="btn-secondary" onclick="toggleFavFromModal(${item.series_id},'${(item.name || '').replace(/'/g, "\\'")}','${(item.cover || '').replace(/'/g, "\\'")}','series')">
        <i class="bi bi-heart"></i> Favoritar
      </button>
    `;

    if (sk.length > 0) {
      document.getElementById('seasonsSection').style.display = 'block';
      document.getElementById('seasonSelect').innerHTML = sk.map(s =>
        `<option value="${s}">Temporada ${s}</option>`
      ).join('');
      currentPlayingSeason = sk[0];
      loadEpisodes();
    }
  } catch (e) {
    document.getElementById('modalDescription').textContent = 'Erro ao carregar detalhes.';
  }
}

function loadEpisodes() {
  const ss = document.getElementById('seasonSelect').value;
  const eg = document.getElementById('episodesGrid');

  if (!currentSeriesInfo || !currentSeriesInfo.episodes || !currentSeriesInfo.episodes[ss]) {
    eg.innerHTML = '<p style="color:var(--text-muted);">Nenhum episÃ³dio encontrado.</p>';
    return;
  }

  const eps = currentSeriesInfo.episodes[ss];
  currentPlayingSeason = ss;

  eg.innerHTML = eps.map(ep => `
    <div class="episode-card" onclick="playEpisode(${ep.id},'${ep.container_extension || 'mp4'}','${(ep.title || 'Ep ' + ep.episode_num).replace(/'/g, "\\'")}')">
      <div class="episode-number">${ep.episode_num || ep.id}</div>
      <div class="episode-info">
        <div class="episode-title">${ep.title || 'EpisÃ³dio ' + ep.episode_num}</div>
        ${ep.info && ep.info.duration ? `<div class="episode-duration"><i class="bi bi-clock"></i> ${ep.info.duration}</div>` : ''}
      </div>
    </div>
  `).join('');
}

function playFirstEpisode() {
  if (!currentSeriesInfo || !currentSeriesInfo.episodes) return;
  const sk = Object.keys(currentSeriesInfo.episodes).sort((a, b) => parseInt(a) - parseInt(b));
  if (!sk.length) return;
  const eps = currentSeriesInfo.episodes[sk[0]];
  if (!eps || !eps.length) return;
  playEpisode(eps[0].id, eps[0].container_extension || 'mp4', eps[0].title || 'EpisÃ³dio ' + eps[0].episode_num);
}

function playEpisode(eid, ext = 'mp4', title = 'EpisÃ³dio') {
  closeModal('detailModal');
  if (currentTab === 'home') {
    document.getElementById('homeSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'grid';
    currentTab = 'series';
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-tab="series"]').classList.add('active');
    document.getElementById('contentTitle').textContent = 'SÃ©ries';
  }
  document.getElementById('playerSection').style.display = 'block';
  currentPlayingEpisodeId = eid;
  playStream(`${API.base}/series/${API.user}/${API.pass}/${eid}.${ext}`, ext === 'mp4' || ext === 'mkv' ? 'mp4' : 'hls', title);
  showPlayerEpisodes();
}

// ---------- PLAYER EPISODES ----------
function showPlayerEpisodes() {
  if (!currentSeriesInfo || !currentSeriesInfo.episodes) {
    hidePlayerEpisodes();
    return;
  }

  const s = document.getElementById('playerEpisodesSection');
  const t = document.getElementById('seriesTitlePlayer');
  const tc = document.getElementById('seasonsTabsPlayer');

  t.textContent = currentSeriesInfo.info?.name || 'SÃ©rie';
  const sk = Object.keys(currentSeriesInfo.episodes).sort((a, b) => parseInt(a) - parseInt(b));

  if (!sk.length) {
    hidePlayerEpisodes();
    return;
  }

  tc.innerHTML = sk.map(se =>
    `<button class="season-tab ${se === currentPlayingSeason ? 'active' : ''}" onclick="selectPlayerSeason('${se}')">T${se}</button>`
  ).join('');

  renderPlayerEpisodes(currentPlayingSeason);
  s.classList.add('show');
}

function selectPlayerSeason(s) {
  currentPlayingSeason = s;
  document.querySelectorAll('#seasonsTabsPlayer .season-tab').forEach(t => {
    t.classList.remove('active');
    if (t.textContent === 'T' + s) t.classList.add('active');
  });
  const ms = document.getElementById('seasonSelect');
  if (ms) ms.value = s;
  renderPlayerEpisodes(s);
}

function renderPlayerEpisodes(s) {
  const sc = document.getElementById('episodesScrollPlayer');
  if (!currentSeriesInfo || !currentSeriesInfo.episodes || !currentSeriesInfo.episodes[s]) {
    sc.innerHTML = '<p style="color:var(--text-muted);padding:1rem;">Nenhum episÃ³dio.</p>';
    return;
  }

  sc.innerHTML = currentSeriesInfo.episodes[s].map(ep => `
    <div class="episode-card-horizontal ${ep.id === currentPlayingEpisodeId ? 'playing' : ''}" 
         onclick="playEpisodeFromPlayer(${ep.id},'${ep.container_extension || 'mp4'}','${(ep.title || 'Ep ' + ep.episode_num).replace(/'/g, "\\'")}')">
      <div class="episode-number-badge">${ep.episode_num || ep.id}</div>
      <div class="ep-title">${ep.title || 'EpisÃ³dio ' + ep.episode_num}</div>
      ${ep.info && ep.info.duration ? `<div class="ep-duration"><i class="bi bi-clock"></i> ${ep.info.duration}</div>` : ''}
    </div>
  `).join('');

  setTimeout(() => {
    const p = sc.querySelector('.playing');
    if (p) p.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
  }, 100);
}

function playEpisodeFromPlayer(eid, ext = 'mp4', title = 'EpisÃ³dio') {
  currentPlayingEpisodeId = eid;
  playStream(`${API.base}/series/${API.user}/${API.pass}/${eid}.${ext}`, ext === 'mp4' || ext === 'mkv' ? 'mp4' : 'hls', title);
  renderPlayerEpisodes(currentPlayingSeason);
}

function hidePlayerEpisodes() {
  document.getElementById('playerEpisodesSection').classList.remove('show');
  currentPlayingSeriesId = null;
  currentPlayingSeason = null;
  currentPlayingEpisodeId = null;
}

// ---------- FAVORITES ----------
function toggleFav(id, name, icon, type) {
  const ex = favorites.find(f => f.id === id);
  if (ex) {
    favorites = favorites.filter(f => f.id !== id);
    showToast('Removido dos favoritos', 'info');
  } else {
    favorites.push({ id, name, icon, type });
    showToast('Adicionado aos favoritos', 'success');
  }
  localStorage.setItem("unitvFav", JSON.stringify(favorites));
  if (currentTab === 'fav') {
    items = favorites.map(f => ({
      stream_id: f.id, series_id: f.id, name: f.name,
      stream_icon: f.icon, cover: f.icon, type: f.type
    }));
    renderItems(items);
  } else if (currentTab !== 'home') {
    renderItems(filteredItems);
  }
}

function toggleFavFromModal(id, name, icon, type) {
  toggleFav(id, name, icon, type);
}

// ---------- GLOBAL SEARCH ----------
document.getElementById("search").addEventListener("input", e => {
  const q = e.target.value.toLowerCase().trim();
  clearTimeout(searchDebounceTimer);
  searchDebounceTimer = setTimeout(() => {
    if (q === '') {
      if (currentTab === 'home') return;
      filteredItems = items;
      renderItems(filteredItems);
      return;
    }

    if (currentTab === 'home') {
      document.getElementById('homeSection').style.display = 'none';
      document.getElementById('mainContent').style.display = 'grid';
      document.getElementById('contentTitle').textContent = `Resultados: "${q}"`;
    }

    let all = [];
    for (const tab of ['live', 'movies', 'series']) {
      for (const k in memoryCache.items[tab]) {
        const a = memoryCache.items[tab][k];
        if (Array.isArray(a)) {
          all.push(...a.filter(i => i.name && i.name.toLowerCase().includes(q)));
        }
      }
    }

    if (items.length > 0) {
      items.filter(i => i.name && i.name.toLowerCase().includes(q)).forEach(r => {
        if (!all.find(a => (a.stream_id || a.series_id) === (r.stream_id || r.series_id))) all.push(r);
      });
    }

    const seen = new Set();
    all = all.filter(i => {
      const id = i.stream_id || i.series_id;
      if (seen.has(id)) return false;
      seen.add(id);
      return true;
    });

    filteredItems = all;
    document.getElementById('contentCount').textContent = `${all.length} resultados`;
    renderItems(all);
  }, SEARCH_DEBOUNCE_MS);
});

// ---------- EVENTS ----------
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeModal('detailModal');
    closeModal('accountModal');
    closeVerMais();
  }
});

document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === m) m.classList.remove('show');
  });
});

window.addEventListener('scroll', () => {
  const h = document.getElementById('appHeader');
  if (h) {
    if (window.scrollY > 50) h.classList.add('scrolled');
    else h.classList.remove('scrolled');
  }
});

if (screen.orientation) {
  screen.orientation.addEventListener('change', () => {
    if (isPlayerActive && player) setTimeout(() => player.dimensions(), 300);
  });
}

window.addEventListener('orientationchange', () => {
  if (isPlayerActive && player) setTimeout(() => player.dimensions(), 300);
});

// ---------- INIT ----------
window.onload = function () {
  if (restoreSession()) {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("app").style.display = "block";
    loadHomepage();
  } else {
    const c = localStorage.getItem('unitvCredentials');
    if (c) {
      const { server, user, pass } = JSON.parse(c);
      document.getElementById('server').value = server;
      document.getElementById('username').value = user;
      document.getElementById('password').value = pass;
    }
  }
};
</script>
</body>
</html>
